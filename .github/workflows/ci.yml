name: CI

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Semantic Version Tag for Docker image'
        required: true
        default: '1.0.0'

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

    steps:
      # Checkout Repository
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      # Setup JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      # Build and SonarQube Scan with Maven
      - name: Build and SonarQube analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          mvn clean verify sonar:sonar \
            -Dsonar.projectKey=DevOpsCalc \
            -Dsonar.host.url=$SONAR_HOST_URL \
            -Dsonar.token=$SONAR_TOKEN \
            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml

      # Checkstyle Lint
      - name: Run Checkstyle
        run: mvn checkstyle:check

      # Upload Checkstyle result as artifact
      - name: Upload Checkstyle result
        uses: actions/upload-artifact@v4
        with:
          name: checkstyle-result
          path: target/checkstyle-result.xml

      # Prepare dependencies for Docker build
      - name: Copy dependencies for Docker
        run: mvn dependency:copy-dependencies -DskipTests

      # Docker Login
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Build Docker Image and push via Fabric8
      - name: Build & Push Docker image
        run: |
          echo "Using Docker tag: ${{ github.event.inputs.version }}"
          mvn io.fabric8:docker-maven-plugin:0.41.0:build \
              io.fabric8:docker-maven-plugin:0.41.0:push \
              -Ddocker.username=${{ env.DOCKER_USERNAME }} \
              -Ddocker.password=${{ env.DOCKER_PASSWORD }} \
              -Ddocker.image.tag=${{ github.event.inputs.version }} \
              -DskipTests
